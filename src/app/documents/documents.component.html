<div class="page">
  <header class="header-slim">
    <div class="container header-flex">
      <div class="logo">ALMA LAB</div>

      <div class="filter-box">
        <button class="filter-btn" (click)="toggleFilters()">
          üìÇ {{ (currentFilter === '–í—Å–µ' || currentFilter === 'All') ? '–ö–∞—Ç–µ–≥–æ—Ä–∏–∏' : currentFilter }}
        </button>

        <div class="menu-backdrop" *ngIf="showFilters" (click)="showFilters = false"></div>

        <div class="filter-menu" *ngIf="showFilters">
          <button class="menu-item" (click)="applyFilter('–í—Å–µ')">‚ö° –í—Å–µ –∑–∞–¥–∞—á–∏</button>
          <div class="menu-scroll">
            <button *ngFor="let cat of docCategories" class="menu-item" (click)="applyFilter(cat)">
              {{ cat }}
            </button>
          </div>
        </div>
      </div>

      <div class="user-info">
  <span class="role-tag">
    {{ role === 'ADMIN' ? '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' : (role === 'SUPERADMIN' ? '–î–∏—Ä–µ–∫—Ç–æ—Ä' : '–°–æ—Ç—Ä—É–¥–Ω–∏–∫') }}
  </span>
        <button class="exit-btn" (click)="logout()">–í—ã–π—Ç–∏</button>
      </div>
    </div>
  </header>

  <main class="container content-area">
    <div class="stats-row">
      <div class="stat-item b-blue" (click)="applyFilter('–í—Å–µ')">
        <div class="val">{{ documents.length }}</div>
        <div class="lbl">–í—Å–µ–≥–æ</div>
      </div>
      <div class="stat-item b-amber">
        <div class="val">{{ counters.toAdmin + counters.toSuper }}</div>
        <div class="lbl">–ù–∞ –ø–æ–¥–ø–∏—Å–∏</div>
      </div>
      <div class="stat-item b-green">
        <div class="val">{{ counters.completed }}</div>
        <div class="lbl">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</div>
      </div>
    </div>

    <div *ngIf="role === 'USER' || role === 'ADMIN'" class="upload-section-card">

      <div class="modal-backdrop" *ngIf="showUploadModal">
        <div class="modal-window upload-setup-modal">
          <h3>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏</h3>
          <p class="file-name-preview">–§–∞–π–ª: <strong>{{ selectedFile?.name }}</strong></p>

          <hr>

          <div class="form-group" *ngIf="role === 'ADMIN'">
            <label>–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è-–ø–æ–ª—É—á–∞—Ç–µ–ª—å:</label>
            <input
              type="text"
              [(ngModel)]="targetOrgName"
              placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –¢–û–û –î–∞—Å—Ç–∞–Ω)"
              class="admin-prompt-input">
            <small class="hint">–£–∫–∞–∂–∏—Ç–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é, –∫–æ—Ç–æ—Ä–∞—è —É–≤–∏–¥–∏—Ç —ç—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç</small>
          </div>

          <div class="form-group">
            <label>–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –¥–æ–∫—É–º–µ–Ω—Ç–∞:</label>
            <select [(ngModel)]="selectedCategory" class="admin-prompt-select">
              <option value="" disabled selected>-- –í—ã–±–µ—Ä–∏—Ç–µ –∏–∑ —Å–ø–∏—Å–∫–∞ --</option>
              <option *ngFor="let cat of docCategories" [value]="cat">{{ cat }}</option>
            </select>
          </div>

          <div class="modal-btns">
            <button class="btn btn-low" (click)="showUploadModal = false">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn btn-high"
                    [disabled]="!selectedCategory || (role === 'ADMIN' && !targetOrgName)"
                    (click)="confirmAndUpload()">
              –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="doc-section">
      <h3 class="section-header">
        {{ currentFilter === '–í—Å–µ' ? '–ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏' : '–†–∞–∑–¥–µ–ª: ' + currentFilter }}
      </h3>

      <div class="document-card" *ngFor="let d of filteredDocuments">
        <div class="card-top">
          <div class="file-info">
            <span class="file-icon">üìÑ</span>
            <span class="name">{{ d.filename }}</span>
          </div>
          <span class="status-badge" [ngClass]="d.status">
            {{ d.status === 'RETURNED' || d.status === 'RETURNED_FOR_FIX' ? '–ù–∞ –¥–æ—Ä–∞–±–æ—Ç–∫–µ' : '–í —Ä–∞–±–æ—Ç–µ' }}
          </span>
        </div>

        <div class="card-meta">
          <span>{{d.organization}}</span>>
          <span>üìÇ {{ d.category }}</span>
          <span>üìÖ {{ d.createdAt | date:'dd.MM.yyyy' }}</span>
        </div>

        <div class="card-btns">
          <button class="btn btn-low" (click)="openDoc(d.id, d.filename)">–°–∫–∞—á–∞—Ç—å</button>

          <ng-container *ngIf="role === 'ADMIN' && d.status === 'SENT_TO_ADMIN'">
            <button class="btn btn-high" (click)="adminSign(d.id)">–ü–æ–¥–ø–∏—Å–∞—Ç—å</button>
            <button class="btn btn-warn" (click)="openReturn(d)">–í–µ—Ä–Ω—É—Ç—å</button>
          </ng-container>

          <ng-container *ngIf="role === 'SUPERADMIN' && d.status === 'SENT_TO_SUPERADMIN'">
            <button class="btn btn-high" (click)="superSign(d.id)">–£—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
            <button class="btn btn-warn" (click)="openReturn(d)">–í–µ—Ä–Ω—É—Ç—å</button>
          </ng-container>
        </div>

        <div *ngIf="(d.status === 'RETURNED' || d.status === 'RETURNED_FOR_FIX') && role === 'USER'" class="admin-note">
          <strong>üîî –ó–∞–º–µ—á–∞–Ω–∏–µ:</strong>
          <p>{{ d.comment || '–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–Ω–µ—Å—Ç–∏ –ø—Ä–∞–≤–∫–∏.' }}</p>
          <label class="re-up">
            üìé –ò—Å–ø—Ä–∞–≤–∏—Ç—å —Ñ–∞–π–ª
            <input type="file" hidden (change)="onReupload(d.id, $event)">
          </label>
        </div>

        <div class="modal-backdrop" *ngIf="returnDoc">
          <div class="modal-window">
            <h3>üîô –í–æ–∑–≤—Ä–∞—Ç –Ω–∞ –¥–æ—Ä–∞–±–æ—Ç–∫—É</h3>
            <p>–î–æ–∫—É–º–µ–Ω—Ç: <strong>{{ returnDoc.filename }}</strong></p>

            <label>–ü—Ä–∏—á–∏–Ω–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ (–∑–∞–º–µ—á–∞–Ω–∏–µ):</label>
            <textarea
              [(ngModel)]="returnComment"
              class="form-control"
              placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –ø–æ–¥–ø–∏—Å–∏ –≤ 3-–º –ø—É–Ω–∫—Ç–µ –∏–ª–∏ –æ—à–∏–±–∫–∞ –≤ –¥–∞—Ç–µ...">
            </textarea>

            <div class="modal-btns">
              <button class="btn btn-low" (click)="closeReturn()">–û—Ç–º–µ–Ω–∞</button>
              <button class="btn btn-warn"
                      [disabled]="!returnComment || returnComment.length < 3"
                      (click)="confirmReturn()">
                –í–µ—Ä–Ω—É—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>
